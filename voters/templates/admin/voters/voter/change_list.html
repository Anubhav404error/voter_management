{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrastyle %}
  {{ block.super }}
  <style>
    .filter-section {
      margin: 15px 0;
      padding: 15px;
      background: #f8f8f8;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .filters-container {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-label {
      font-weight: 600;
      color: #444;
      white-space: nowrap;
      min-width: 100px;
    }

    .filter-select {
      padding: 6px 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      min-width: 200px;
      font-size: 14px;
      background-color: white;
    }

    .filter-select:focus {
      outline: none;
      border-color: #79aec8;
      box-shadow: 0 0 0 2px rgba(121, 174, 200, 0.2);
    }

    .buttons-group {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .custom-button {
      padding: 8px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      font-size: 13px;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .apply-btn {
      background-color: #79aec8;
      color: white;
    }

    .apply-btn:hover {
      background-color: #609ab6;
    }

    .clear-btn {
      background-color: #f8f9fa;
      color: #444;
      border: 1px solid #ddd;
    }

    .clear-btn:hover {
      background-color: #e9ecef;
      border-color: #c6c8ca;
    }

    .status-info {
      background: #fff;
      padding: 12px 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .status-info-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-label {
      font-weight: 600;
      color: #666;
    }

    .status-value {
      color: #333;
    }

    .filter-select:disabled {
      background-color: #f5f5f5;
      cursor: not-allowed;
      border-color: #ddd;
    }

    .upload-excel-btn {
      background-color: #28a745;
      color: white;
      padding: 8px 15px;
      border-radius: 4px;
      text-decoration: none;
      margin-right: 10px;
      font-weight: 600;
      transition: background-color 0.3s;
    }

    .upload-excel-btn:hover {
      background-color: #218838;
      color: white;
      text-decoration: none;
    }

    .object-tools {
      margin-top: 15px;
    }

    @media (max-width: 1200px) {
      .filters-container {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-label {
        margin-bottom: 5px;
      }

      .buttons-group {
        margin-left: 0;
        margin-top: 15px;
        justify-content: flex-end;
      }
    }
  </style>
{% endblock %}

{% block object-tools %}

<div class="object-tools">
    {% block object-tools-items %}
        <a href="{% url 'admin:voter-upload-excel' %}" class="upload-excel-btn">
            <i class="fas fa-file-excel"></i> Upload Excel
        </a>
        {% if has_add_permission %}
            {% url cl.opts|admin_urlname:'add' as add_url %}
            <a href="{% add_preserved_filters add_url is_popup to_field %}" class="addlink">
                {% blocktranslate with cl.opts.verbose_name as name %}Add {{ name }}{% endblocktranslate %}
            </a>
        {% endif %}
    {% endblock %}
</div>
<div class="status-info">
    <div class="status-info-item">
        <span class="status-label">Current Date and Time (UTC):</span>
        <span class="status-value">{{ current_datetime|date:"Y-m-d H:i:s" }}</span>
    </div>
    <div class="status-info-item">
        <span class="status-label">Current User's Login:</span>
        <span class="status-value">{{ current_user }}</span>
    </div>
</div>


<div class="filter-section">
    <div class="filters-container">
        <div class="filter-group">
            <label class="filter-label">MLC Constituency:</label>
            <select id="mlc-filter" class="filter-select">
                <option value="">All Constituencies</option>
                {% for mlc in unique_mlc %}
                    <option value="{{ mlc }}" {% if current_filters.mlc_constituncy == mlc %}selected{% endif %}>
                        {{ mlc }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">Assembly:</label>
            <select id="assembly-filter" class="filter-select" disabled>
                <option value="">All Assemblies</option>
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">Mandal:</label>
            <select id="mandal-filter" class="filter-select" disabled>
                <option value="">All Mandals</option>
            </select>
        </div>

        <div class="filter-group">
            <label class="filter-label">Village:</label>
            <select id="village-filter" class="filter-select" disabled>
                <option value="">All Villages</option>
            </select>
        </div>

        <div class="buttons-group">
            <button id="apply-filters" class="custom-button apply-btn">Apply Filters</button>
            <button id="clear-filters" class="custom-button clear-btn">Clear Filters</button>
        </div>
    </div>
</div>


{% endblock %}

{% block result_list %}
    {{ block.super }}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mlcFilter = document.getElementById('mlc-filter');
    const assemblyFilter = document.getElementById('assembly-filter');
    const mandalFilter = document.getElementById('mandal-filter');
    const villageFilter = document.getElementById('village-filter');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const clearFiltersBtn = document.getElementById('clear-filters');

    // Function to enable/disable select elements
    function updateSelectState(select, enabled) {
        select.disabled = !enabled;
        if (!enabled) {
            select.innerHTML = `<option value="">All ${select.previousElementSibling.textContent.slice(0, -1)}s</option>`;
        }
    }

    // Function to populate select elements
    async function populateSelect(select, url, parentValue, currentValue = '') {
        try {
            updateSelectState(select, true);
            const response = await fetch(`${url}?${new URLSearchParams({
                [select.id.split('-')[0]]: parentValue
            })}`);
            const data = await response.json();

            const label = select.previousElementSibling.textContent.slice(0, -1);
            select.innerHTML = `<option value="">All ${label}s</option>`;

            // Sort the data alphabetically
            data.sort().forEach(option => {
                if (option) {  // Only add non-empty values
                    const optElement = new Option(option, option);
                    if (option === currentValue) {
                        optElement.selected = true;
                    }
                    select.add(optElement);
                }
            });

            // If no options were added (except the "All" option), disable the select
            if (select.options.length === 1) {
                updateSelectState(select, false);
            }
        } catch (error) {
            console.error('Error populating select:', error);
            updateSelectState(select, false);
        }
    }

    // Function to update dependent dropdowns
    async function updateDependentDropdowns(changedFilter) {
        try {
            if (changedFilter === 'mlc' || changedFilter === 'all') {
                const mlcValue = mlcFilter.value;
                if (mlcValue) {
                    await populateSelect(
                        assemblyFilter,
                        "{% url 'admin:get-assemblies' %}",
                        mlcValue,
                        '{{ current_filters.assembly }}'
                    );
                } else {
                    updateSelectState(assemblyFilter, false);
                    updateSelectState(mandalFilter, false);
                    updateSelectState(villageFilter, false);
                }
            }

            if ((changedFilter === 'assembly' || changedFilter === 'all') && !assemblyFilter.disabled) {
                const assemblyValue = assemblyFilter.value;
                if (assemblyValue) {
                    await populateSelect(
                        mandalFilter,
                        "{% url 'admin:get-mandals' %}",
                        assemblyValue,
                        '{{ current_filters.mandal }}'
                    );
                } else {
                    updateSelectState(mandalFilter, false);
                    updateSelectState(villageFilter, false);
                }
            }

            if ((changedFilter === 'mandal' || changedFilter === 'all') && !mandalFilter.disabled) {
                const mandalValue = mandalFilter.value;
                if (mandalValue) {
                    await populateSelect(
                        villageFilter,
                        "{% url 'admin:get-villages' %}",
                        mandalValue,
                        '{{ current_filters.village }}'
                    );
                } else {
                    updateSelectState(villageFilter, false);
                }
            }
        } catch (error) {
            console.error('Error updating filters:', error);
        }
    }

    // Event listeners
    mlcFilter.addEventListener('change', () => updateDependentDropdowns('mlc'));
    assemblyFilter.addEventListener('change', () => updateDependentDropdowns('assembly'));
    mandalFilter.addEventListener('change', () => updateDependentDropdowns('mandal'));

    // Apply filters
    applyFiltersBtn.addEventListener('click', function() {
        const params = new URLSearchParams(window.location.search);
        const filters = {
            'mlc_constituncy': mlcFilter.value,
            'assembly': assemblyFilter.value,
            'mandal': mandalFilter.value,
            'village': villageFilter.value
        };

        Object.entries(filters).forEach(([key, value]) => {
            if (value) {
                params.set(key, value);
            } else {
                params.delete(key);
            }
        });

        window.location.search = params.toString();
    });

    // Clear filters
    clearFiltersBtn.addEventListener('click', function() {
        mlcFilter.value = '';
        updateDependentDropdowns('all');
        window.location.search = '';
    });

    // Initialize filters if values are present
    if ('{{ current_filters.mlc_constituncy }}') {
        updateDependentDropdowns('all');
    }
});
</script>
{% endblock %}